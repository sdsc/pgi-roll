<?xml version="1.0" standalone="no"?>

<kickstart>

<description>
Software Environment Modules 3.2.5 common configuration for PGI compilers
http://modules.sourceforge.net
</description>

<copyright>
Copyright (c) 2000 - 2009 The Regents of the University of California.
All rights reserved. Rocks(r) v5.1 www.rocksclusters.org
</copyright>

<changelog>
</changelog>

<post>

# Make sure modules package reads modulefiles from /opt/modulefiles/compilers
line='setenv MODULEPATH /opt/modulefiles/compilers:$MODULEPATH'
if test `grep -Fc "$line" /etc/profile.d/modules.csh` = 0; then
  echo "$line" >> /etc/profile.d/modules.csh
fi
line='export MODULEPATH=/opt/modulefiles/compilers:$MODULEPATH'
if test `grep -Fc "$line" /etc/profile.d/modules.sh` = 0; then
  echo "$line" >> /etc/profile.d/modules.sh
fi

# Add module files for the PGI compilers
<!-- env vars in <file> tags don't work, so use fixed-path temps -->
/bin/mkdir -m 0755 -p /opt/modulefiles/compilers/pgi
/bin/mkdir -m 0755 -p /opt/modulefiles/.tmp
export version=8.0

<file name="/opt/modulefiles/.tmp/pgi" perms="0644">
#%Module1.0
module-whatis "PGI compilers"
module-whatis "Version: VERSION"
module-whatis "Description: PGI compilers (C/C++/Fortran)"

# Unload any compiler-dependent modules
if {[module-info mode switch1] || [module-info mode switch3]} {
  set commandWords [split [exec /bin/ps -p [pid] -o args=] " "]
  set switchFrom [lindex [split [module-info name] "/"] 0]
  set switchTo [lindex [split [lindex $commandWords end] "/"] 0]
  set unloadApps [expr ! [string equal $switchTo $switchFrom]]
} elseif {[module-info mode remove]} {
  set unloadApps 1
} else {
  set unloadApps 0
}
if {$unloadApps} {
  foreach app [split [exec /bin/ls /opt/modulefiles/applications/.pgi]] {
    module unload $app
  }
}
prepend-path MODULEPATH /opt/modulefiles/applications/.pgi

# Compiler environment modifications
prepend-path PATH "/opt/pgi/linux86-64/VERSION/bin"
prepend-path LD_LIBRARY_PATH "/opt/pgi/linux86-64/VERSION/libso"

</file>
/usr/bin/perl -pi -e "s/VERSION/$version/" /opt/modulefiles/.tmp/pgi
/bin/cp /opt/modulefiles/.tmp/pgi /opt/modulefiles/compilers/pgi/$version

<file name="/opt/modulefiles/.tmp/pgi.version" perms="0644">
#%Module1.0
set ModulesVersion "VERSION"
</file>
/usr/bin/perl -pi -e "s/VERSION/$version/" /opt/modulefiles/.tmp/pgi.version
/bin/cp /opt/modulefiles/.tmp/pgi.version \
        /opt/modulefiles/compilers/pgi/.version.$version

/bin/ln -s /opt/modulefiles/compilers/pgi/.version.$version \
           /opt/modulefiles/compilers/pgi/.version

# Add module files for the pre-installed gnu compilers
/bin/mkdir -m 0755 -p /opt/modulefiles/compilers/gnu
export version=`gcc --version | head -1 | awk ' {print $3}'`

<file name="/opt/modulefiles/.tmp/gnu" perms="0644">
#%Module1.0
module-whatis "GNU compilers"
module-whatis "Version: VERSION"
module-whatis "Description: GNU compilers"

# Unload any compiler-dependent modules
if {[module-info mode switch1] || [module-info mode switch3]} {
  set commandWords [split [exec /bin/ps -p [pid] -o args=] " "]
  set switchFrom [lindex [split [module-info name] "/"] 0]
  set switchTo [lindex [split [lindex $commandWords end] "/"] 0]
  set unloadApps [expr ! [string equal $switchTo $switchFrom]]
} elseif {[module-info mode remove]} {
  set unloadApps 1
} else {
  set unloadApps 0
}
if {$unloadApps} {
  foreach app [split [exec /bin/ls /opt/modulefiles/applications/.gnu]] {
    module unload $app
  }
}
prepend-path MODULEPATH /opt/modulefiles/applications/.gnu

# Compiler environment modifications: none needed
</file>
/usr/bin/perl -pi -e "s/VERSION/$version/" /opt/modulefiles/.tmp/gnu
/bin/cp /opt/modulefiles/.tmp/gnu /opt/modulefiles/compilers/gnu/$version

<file name="/opt/modulefiles/.tmp/gnu.version" perms="0644">
#%Module1.0
set ModulesVersion "VERSION"
</file>
/usr/bin/perl -pi -e "s/VERSION/$version/" /opt/modulefiles/.tmp/gnu.version
/bin/cp /opt/modulefiles/.tmp/gnu.version \
        /opt/modulefiles/compilers/gnu/.version.$version

/bin/ln -s /opt/modulefiles/compilers/gnu/.version.$version \
           /opt/modulefiles/compilers/gnu/.version

</post>

</kickstart>
